<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CINEPALETTE: Blur Edition</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* --- TASARIM --- */
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; text-align: center; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        .screen { display: none; width: 90%; max-width: 500px; padding: 25px; background: #1e1e1e; border-radius: 15px; margin-top: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
        .active { display: flex; flex-direction: column; align-items: center; }
        
        h1 { color: #FFD700; margin-bottom: 5px; letter-spacing: 2px; }
        
        /* Form Elemanlarƒ± */
        input, select, button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; }
        input, select { background: #333; color: #fff; border: 1px solid #444; outline: none; }
        button { background: #FFD700; color: #000; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 15px; }
        button:hover { transform: scale(1.02); background: #ffea70; }
        
        /* Kategori Etiketi */
        .category-tag { background: #333; color: #FFD700; padding: 5px 10px; border-radius: 5px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }

        /* Oda Kodu */
        .room-code { font-size: 40px; letter-spacing: 5px; color: #28a745; font-family: monospace; margin: 15px 0; border: 2px dashed #444; padding: 10px; width: 100%; }
        
        /* Oyun Alanƒ± */
        .palette-container { display: flex; width: 100%; height: 80px; border: 2px solid #555; margin-bottom: 10px; border-radius: 8px; overflow: hidden; }
        .color-box { flex: 1; height: 100%; }
        
        /* POSTER ALANI (YENƒ∞) */
        #poster-container {
            display: none; /* Sadece posterli sorularda a√ßƒ±lacak */
            justify-content: center;
            margin-bottom: 15px;
            position: relative;
        }
        #game-poster {
            width: 160px;
            height: 240px;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid #fff;
            /* ƒ∞≈ûTE Sƒ∞Hƒ∞R BURADA: BULANIKLIK */
            filter: blur(10px); 
            transition: filter 0.5s ease;
        }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .option-btn { padding: 15px; background: #2a2a2a; color: #fff; border: 1px solid #444; cursor: pointer; transition: 0.2s; }
        .option-btn:hover { background: #3a3a3a; }
        .correct { background: #28a745 !important; }
        .wrong { background: #dc3545 !important; }
        
        /* Tablo */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        th { color: #FFD700; }
        
        .loader { border: 4px solid #333; border-top: 4px solid #FFD700; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>CINEPALETTE</h1>
        <p style="color:#aaa; font-size:14px;">Renkler ve Bulanƒ±k Posterler</p>
        
        <input type="text" id="username" placeholder="Adƒ±n / Lakabƒ±n">
        
        <div style="background: #252525; padding: 15px; border-radius: 10px; margin: 20px 0; width: 100%; box-sizing: border-box;">
            <h3 style="margin:0 0 10px 0; color:#FFD700; text-align:left;">ODA KUR</h3>
            <label style="display:block; text-align:left; color:#aaa; font-size:12px; margin-bottom:5px;">Kategori Se√ß:</label>
            <select id="category-select">
                <option value="mix">üé≤ Karƒ±≈üƒ±k (Hepsi)</option>
                <option value="poster_blur">üñºÔ∏è Sadece Bulanƒ±k Posterler</option>
                <option value="horror">üëª Korku / Gerilim</option>
                <option value="scifi">üöÄ Bilim Kurgu</option>
                <option value="animation">üß∏ Animasyon</option>
            </select>
            <button onclick="createRoom()">ODA OLU≈ûTUR</button>
        </div>

        <div style="display:flex; align-items:center; gap:10px; margin: 20px 0;">
            <hr style="flex:1; border-color:#333"> <span style="color:#555; font-size:12px">VEYA</span> <hr style="flex:1; border-color:#333">
        </div>

        <input type="text" id="room-code-input" placeholder="Oda Kodu Gir">
        <button onclick="joinRoom()" style="background:#444; color:#fff;">ODAYA KATIL</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h2>LOBƒ∞</h2>
        <div class="category-tag" id="lobby-category-display">...</div>
        <p>Oda Kodu:</p>
        <div class="room-code" id="display-room-code">----</div>
        <ul id="player-list" style="list-style:none; padding:0; width:100%"></ul>
        <div id="host-controls" style="display:none; width:100%"><button onclick="startGameByHost()">BA≈ûLAT</button></div>
        <p id="guest-msg" style="color:#aaa; font-size:12px">Oda sahibi bekleniyor...</p>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; width:100%; font-weight:bold; margin-bottom:10px">
            <span id="game-timer" style="font-size:20px; color:#FFD700">15</span>
            <span id="game-score">0 Puan</span>
        </div>
        
        <div class="category-tag" id="game-category-tag"></div>
        
        <div class="palette-container" id="palette-box"></div>

        <div id="poster-container">
            <img id="game-poster" src="" alt="Movie Poster">
        </div>

        <div class="options-grid" id="options-box"></div>
        <div id="game-msg" style="height:20px; font-weight:bold; margin-top:15px"></div>
    </div>

    <div id="screen-waiting" class="screen">
        <h2>Bƒ∞Tƒ∞RDƒ∞N!</h2>
        <p>Herkesin bitirmesi bekleniyor...</p>
        <div class="loader"></div>
        <p id="waiting-status" style="color:#aaa">...</p>
    </div>

    <div id="screen-result" class="screen">
        <h1>üèÜ SONU√áLAR</h1>
        <table id="leaderboard-table">
            <thead><tr><th>#</th><th>Oyuncu</th><th>Puan</th></tr></thead>
            <tbody></tbody>
        </table>
        <button onclick="location.reload()" style="margin-top:20px">ANA MEN√ú</button>
    </div>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyCKXuqXEtQ_dr1FNw-8NZj0BpeoSDl_mRY",
  authDomain: "cinepalette-e7a2b.firebaseapp.com",
  databaseURL: "https://cinepalette-e7a2b-default-rtdb.firebaseio.com",
  projectId: "cinepalette-e7a2b",
  storageBucket: "cinepalette-e7a2b.firebasestorage.app",
  messagingSenderId: "933599264840",
  appId: "1:933599264840:web:667563470c4ea338f7187d"
};
        // -----------------------------------------------------------

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- Fƒ∞LM VERƒ∞TABANI ---
        // Not: 'posterUrl' kƒ±smƒ±na internetteki ge√ßerli resim linkleri gelmeli.
        const allQuestions = [
            // --- BULANIK POSTER KATEGORƒ∞Sƒ∞ (PosterUrl Dolu Olanlar) ---
            { 
                category: "poster_blur", 
                colors: ["#0d1b2a", "#1b263b", "#415a77", "#778da9", "#e0e1dd"], 
                correct: "Titanic", 
                posterUrl: "https://upload.wikimedia.org/wikipedia/en/1/18/Titanic_%281997_film%29_poster.png",
                options: ["Titanic", "Avatar", "The Notebook", "Pearl Harbor"] 
            },
            { 
                category: "poster_blur", 
                colors: ["#000000", "#FFD700", "#8B0000", "#FFFFFF", "#333333"], 
                correct: "The Godfather", 
                posterUrl: "https://upload.wikimedia.org/wikipedia/en/1/1c/Godfather_ver1.jpg",
                options: ["Scarface", "The Godfather", "Goodfellas", "Casino"] 
            },
            { 
                category: "poster_blur", 
                colors: ["#2C3E50", "#E74C3C", "#ECF0F1", "#3498DB", "#F1C40F"], 
                correct: "Spider-Man", 
                posterUrl: "https://upload.wikimedia.org/wikipedia/en/f/f3/Spider-Man2002Poster.jpg",
                options: ["Spider-Man", "Iron Man", "Superman", "Batman"] 
            },
            { 
                category: "poster_blur", 
                colors: ["#1C2833", "#F4D03F", "#000000", "#5D6D7E", "#FFFFFF"], 
                correct: "Batman: The Dark Knight", 
                posterUrl: "https://upload.wikimedia.org/wikipedia/en/1/1c/The_Dark_Knight_%282008_film%29.jpg",
                options: ["Joker", "Batman Begins", "The Dark Knight", "Superman"] 
            },
            { 
                category: "poster_blur", 
                colors: ["#2E86C1", "#17202A", "#2ECC71", "#FFFFFF", "#34495E"], 
                correct: "Avatar", 
                posterUrl: "https://upload.wikimedia.org/wikipedia/en/d/d6/Avatar_%282009_film%29_poster.jpg",
                options: ["Avatar", "Tron", "Star Wars", "Dune"] 
            },

            // --- Dƒ∞ƒûER KATEGORƒ∞LER (Sadece Renk) ---
            { category: "horror", colors: ["#000000", "#8B0000", "#FF4500", "#1C1C1C", "#FFFFFF"], correct: "The Shining", options: ["It", "The Shining", "Carrie", "Misery"] },
            { category: "horror", colors: ["#FFFFFF", "#FF0000", "#FFFF00", "#000000", "#555555"], correct: "It", options: ["It", "Joker", "Clown", "Poltergeist"] },
            { category: "scifi", colors: ["#000000", "#0D2615", "#00FF41", "#1A4D2E", "#FFFFFF"], correct: "The Matrix", options: ["Hulk", "The Matrix", "Tron", "Inception"] },
            { category: "scifi", colors: ["#F5DEB3", "#C2B280", "#8B4513", "#2F4F4F", "#000000"], correct: "Dune", options: ["Mad Max", "Dune", "Star Wars", "Prometheus"] },
            { category: "animation", colors: ["#4B8BBE", "#FFD43B", "#FFFFFF", "#306998", "#000000"], correct: "Minions", options: ["Simpsonlar", "S√ºnger Bob", "Minions", "Pokemon"] },
            { category: "animation", colors: ["#7D3C98", "#2ECC71", "#F39C12", "#E74C3C", "#3498DB"], correct: "Inside Out", options: ["Up", "Inside Out", "Soul", "Coco"] }
        ];

        // --- DEƒûƒ∞≈ûKENLER ---
        let myName = "", myRoomCode = "", myId = "", isHost = false;
        let currentQuestions = [], currentQIndex = 0, score = 0, lives = 3;
        let timerInterval;

        // --- FONKSƒ∞YONLAR ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function generateCode() { return Math.floor(1000 + Math.random() * 9000).toString(); }
        function getCategoryName(key) {
            const names = { "mix": "Karƒ±≈üƒ±k", "poster_blur": "Bulanƒ±k Poster", "horror": "Korku", "scifi": "Bilim Kurgu", "animation": "Animasyon" };
            return names[key] || "Bilinmiyor";
        }

        // --- ODA Y√ñNETƒ∞Mƒ∞ ---
        function createRoom() {
            myName = document.getElementById('username').value.trim();
            const category = document.getElementById('category-select').value;
            if(!myName) return alert("ƒ∞sim gir!");
            myRoomCode = generateCode(); isHost = true;
            db.ref('rooms/' + myRoomCode).set({ status: "lobby", category: category, createdAt: Date.now() });
            joinMyOwnRoom();
        }

        function joinRoom() {
            myName = document.getElementById('username').value.trim();
            myRoomCode = document.getElementById('room-code-input').value.trim();
            if(!myName || !myRoomCode) return alert("Bilgiler eksik!");
            db.ref('rooms/' + myRoomCode).get().then((snap) => {
                if (snap.exists() && snap.val().status === "lobby") joinMyOwnRoom();
                else alert("Oda yok veya oyun ba≈ülamƒ±≈ü!");
            });
        }

        function joinMyOwnRoom() {
            const playerRef = db.ref(`rooms/${myRoomCode}/players`).push();
            myId = playerRef.key;
            playerRef.set({ name: myName, score: 0, status: "waiting" });
            setupLobby();
        }

        function setupLobby() {
            showScreen('screen-lobby');
            document.getElementById('display-room-code').innerText = myRoomCode;
            if(isHost) document.getElementById('host-controls').style.display = 'block';
            else document.getElementById('guest-msg').style.display = 'block';

            const roomRef = db.ref('rooms/' + myRoomCode);
            roomRef.child('players').on('value', (snap) => {
                const list = document.getElementById('player-list'); list.innerHTML = '';
                if(snap.val()) Object.values(snap.val()).forEach(p => {
                    list.innerHTML += `<li><span>${p.name}</span> <span>${p.score} P</span></li>`;
                });
            });
            roomRef.once('value').then(snap => {
                document.getElementById('lobby-category-display').innerText = getCategoryName(snap.val().category);
            });
            roomRef.child('status').on('value', (snap) => {
                if(snap.val() === 'playing') {
                    roomRef.child('category').once('value').then(c => startGame(c.val()));
                } else if(snap.val() === 'finished') showFinalResults();
            });
        }

        function startGameByHost() { db.ref('rooms/' + myRoomCode).update({ status: "playing" }); }

        // --- OYUN MOTORU ---
        function startGame(catKey) {
            // Filtreleme
            if (catKey === 'mix') currentQuestions = allQuestions.sort(() => Math.random() - 0.5).slice(0, 10);
            else currentQuestions = allQuestions.filter(q => q.category === catKey).sort(() => Math.random() - 0.5);

            if(currentQuestions.length === 0) { alert("Bu kategoride soru yok!"); return; }

            showScreen('screen-game');
            document.getElementById('game-category-tag').innerText = getCategoryName(catKey);
            currentQIndex = 0; score = 0; lives = 3;
            db.ref(`rooms/${myRoomCode}/players/${myId}`).update({ status: "playing" });
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQIndex >= currentQuestions.length || lives <= 0) { finishGameLocal(); return; }
            const q = currentQuestions[currentQIndex];
            
            const paletteBox = document.getElementById('palette-box');
            const posterContainer = document.getElementById('poster-container');
            const posterImg = document.getElementById('game-poster');
            
            paletteBox.innerHTML = ''; document.getElementById('options-box').innerHTML = '';
            document.getElementById('game-msg').innerText = '';

            // 1. Renkler
            q.colors.forEach(c => {
                const div = document.createElement('div');
                div.className = 'color-box'; div.style.backgroundColor = c;
                paletteBox.appendChild(div);
            });

            // 2. Poster (Varsa G√∂ster, Yoksa Gizle)
            if(q.posterUrl) {
                posterContainer.style.display = 'flex';
                posterImg.src = q.posterUrl;
                // Her seferinde efekti sƒ±fƒ±rla (bazen takƒ±labilir)
                posterImg.style.filter = "blur(12px)";
            } else {
                posterContainer.style.display = 'none';
            }

            // 3. ≈ûƒ±klar
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn'; btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, q.correct, btn, q.posterUrl);
                document.getElementById('options-box').appendChild(btn);
            });
            startTimer();
        }

        function startTimer() {
            let timeLeft = 15;
            document.getElementById('game-timer').innerText = timeLeft;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('game-timer').innerText = timeLeft;
                if(timeLeft <= 0) { clearInterval(timerInterval); handleWrong("S√ºre Doldu!"); }
            }, 1000);
        }

        function checkAnswer(selected, correct, btn, hasPoster) {
            clearInterval(timerInterval);
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

            // Eƒüer posterli soruysa, bilince netle≈üsin!
            if(hasPoster) {
                document.getElementById('game-poster').style.filter = "blur(0px)";
            }

            if (selected === correct) {
                btn.classList.add('correct'); score += 10;
                document.getElementById('game-score').innerText = score + " Puan";
                setTimeout(() => { currentQIndex++; loadQuestion(); }, 2000); // Resmi g√∂rmesi i√ßin s√ºre uzatƒ±ldƒ±
            } else {
                btn.classList.add('wrong');
                handleWrong("Yanlƒ±≈ü!");
            }
        }

        function handleWrong(msg) {
            lives--;
            const msgDiv = document.getElementById('game-msg');
            msgDiv.innerText = msg; msgDiv.style.color = "#dc3545";
            setTimeout(() => {
                if(lives <= 0) finishGameLocal();
                else { currentQIndex++; loadQuestion(); }
            }, 2000);
        }

        function finishGameLocal() {
            clearInterval(timerInterval);
            db.ref(`rooms/${myRoomCode}/players/${myId}`).update({ score: score, status: "finished" });
            showScreen('screen-waiting');
            
            const playersRef = db.ref(`rooms/${myRoomCode}/players`);
            playersRef.on('value', (snap) => {
                const arr = Object.values(snap.val());
                const fin = arr.filter(p => p.status === "finished").length;
                document.getElementById('waiting-status').innerText = `${fin} / ${arr.length} ki≈üi bitti.`;
                if(isHost && fin === arr.length) db.ref('rooms/' + myRoomCode).update({ status: "finished" });
            });
        }

        function showFinalResults() {
            showScreen('screen-result');
            const tbody = document.querySelector('#leaderboard-table tbody'); tbody.innerHTML = '';
            db.ref(`rooms/${myRoomCode}/players`).once('value').then(snap => {
                const players = Object.values(snap.val());
                players.sort((a, b) => b.score - a.score);
                players.forEach((p, i) => {
                    tbody.innerHTML += `<tr style="${i===0?'color:#FFD700':''}"><td>${i+1}</td><td>${p.name}</td><td>${p.score}</td></tr>`;
                });
            });
        }
    </script>
</body>
</html>